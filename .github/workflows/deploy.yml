name: Deploy Production

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production
    steps:
    - name: Deploy via SSH
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USERNAME }}
        password: ${{ secrets.SSH_PASSWORD }}
        port: ${{ secrets.SSH_PORT }}
        command_timeout: 30m
        script: |
          # Paths
          LARAVEL_PATH="/home/u131862867/domains/honda-ciledug.com/laravel"
          PUBLIC_PATH="/home/u131862867/domains/honda-ciledug.com/public_html"

          # Ensure laravel folder exists
          mkdir -p "$LARAVEL_PATH"
          cd "$LARAVEL_PATH"

          # 1. Clone or Pull
          if [ ! -d ".git" ]; then
              echo "=== Cloning repository ==="
              git clone https://github.com/alvaerasolution-alt/hondaCiledugCompany.git .
          else
              echo "=== Pulling latest changes ==="
              git pull origin main
          fi

          # 2. Maintenance mode
          php artisan down || true

          # 3. Composer install
          export COMPOSER_ALLOW_SUPERUSER=1
          composer install --no-dev --no-interaction --prefer-dist --optimize-autoloader

          # 4. NPM install & build
          export PATH="$HOME/nodejs/bin:$PATH"
          npm install
          npm run build

          # 5. Copy public files to public_html
          echo "=== Syncing public files to public_html ==="
          rsync -av --delete \
            --exclude='.htaccess' \
            --exclude='storage' \
            "$LARAVEL_PATH/public/" "$PUBLIC_PATH/"

          # 6. Copy production index.php
          cp "$LARAVEL_PATH/.deploy/index.php" "$PUBLIC_PATH/index.php"

          # 7. Storage symlink
          ln -sfn "$LARAVEL_PATH/storage/app/public" "$PUBLIC_PATH/storage"

          # 8. Framework optimize
          php artisan optimize:clear
          php artisan config:cache
          php artisan route:cache
          php artisan view:cache

          # 9. Migrate
          php artisan migrate --force

          # 10. Bring back up
          php artisan up

          echo "=== Deploy complete ==="
